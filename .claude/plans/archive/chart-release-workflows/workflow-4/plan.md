# Workflow 4: Format Atomic Chart PRs - Phase Plan

> [!WARNING]
> **OBSOLETE**: This workflow is no longer needed in the simplified flow.
>
> **Original Purpose**: Create and format PRs from `integration/<chart>` to `main` after merges to `integration/<chart>`.
>
> **Why Obsolete**: W2 was simplified to create the PR to `main` directly as part of its flow, eliminating the need for a separate workflow to create these PRs. W2 now:
> 1. Validates and lints the chart
> 2. Pushes to `integration/<chart>`
> 3. Creates the PR to `main` with proper formatting
>
> **Replaced By**: W2 Phase 2.6 (PR Creation) handles all PR formatting and creation.
>
> **Remaining Value**: The PR body template and attestation map format patterns may be useful reference for W2's PR creation step.

---

## Overview
**Trigger**: `push` → `integration/*` branches
**Purpose**: Create PR from `integration/<chart>` to `main` with proper formatting

---

## Relevant Skills

Load these skills before planning, research, or implementation:

| Skill | Path | Relevance |
|-------|------|-----------|
| **CI/CD GitHub Actions** | `~/.claude/skills/cicd-github-actions-dev/SKILL.md` | PR creation, gh CLI patterns, workflow triggers |
| **Helm Chart Development** | `~/.claude/skills/k8s-helm-charts-dev/SKILL.md` | Chart metadata extraction for PR formatting |

**How to load**: Read the SKILL.md files at the start of implementation to access patterns and best practices.

---

## Prerequisites

### Shared Components Required (Build First)
- [ ] `extract_attestation_map` shell function

### Infrastructure Required
- [ ] `main` branch protection configured
- [ ] `main-protection` ruleset requires PR

### Upstream Dependencies
- [ ] Workflow 3 must have merged the PR (triggers this workflow)

---

## Implementation Phases

### Phase 4.1: Base Workflow Structure
**Effort**: Low
**Dependencies**: None

**Tasks**:
1. Create `.github/workflows/format-atomic-prs.yaml`
2. Configure trigger for `push` → `integration/*`
3. Set up permissions (pull-requests: write, contents: read)

**Deliverable**: Workflow triggers on merge to any `integration/<chart>` branch

---

### Phase 4.2: Chart Name Extraction
**Effort**: Low
**Dependencies**: Phase 4.1

**Tasks**:
1. Extract chart name from branch name
2. Parse `refs/heads/integration/<chart>` to get `<chart>`

**Code**:
```bash
# Branch is refs/heads/integration/<chart>
BRANCH="${{ github.ref }}"
CHART_NAME="${BRANCH#refs/heads/integration/}"
```

---

### Phase 4.3: Source PR Chain Discovery
**Effort**: Medium
**Dependencies**: Phase 4.1, `extract_attestation_map`

**Tasks**:
1. Find the PR that merged to this `integration/<chart>` branch
2. Extract its body for attestation map
3. Find the original source PR (from Workflow 1)
4. Build the PR lineage chain

**Questions**:
- [ ] How many levels back to trace? Just one or full lineage?
- [ ] What if original PR is not found?

**Gaps**:
- Need reliable method to trace PR chain

---

### Phase 4.4: Check for Existing PR
**Effort**: Low
**Dependencies**: Phase 4.2

**Tasks**:
1. Query for existing PR `integration/<chart>` → `main`
2. If exists, workflow can exit (PR auto-updates)
3. If not, proceed to create

**Code**:
```bash
EXISTING=$(gh pr list \
  --head "integration/$CHART" \
  --base main \
  --state open \
  --json number \
  -q '.[0].number')
```

---

### Phase 4.5: PR Creation
**Effort**: Medium
**Dependencies**: Phase 4.3, Phase 4.4

**Tasks**:
1. Create PR body with:
   - Release preparation header
   - Lineage table (Feature→Integration, Integration→chart, chart→main)
   - Attestation map from source
   - Checklist for review
2. Create PR using `gh pr create` or `peter-evans/create-pull-request`
3. Apply appropriate labels

**PR Body Template**:
```markdown
## Release Preparation: <chart>

This PR prepares the `<chart>` chart for release.

### Lineage

| Stage | PR |
|-------|-----|
| Feature → Integration | #<original-pr> |
| Integration → integration/<chart> | #<intermediate-pr> |
| integration/<chart> → main | This PR |

### Attestation Map

<!-- ATTESTATION_MAP
<copied from source>
-->

### Checklist

- [ ] Attestation lineage verified
- [ ] Version bump determined
- [ ] Changelog reviewed

---
*Auto-generated by Workflow 4: Format Atomic Chart PRs*
```

**Questions**:
- [ ] Should PR be auto-assigned to specific reviewers?
- [ ] What labels to apply?

---

### Phase 4.6: PR Update (If Exists)
**Effort**: Low
**Dependencies**: Phase 4.4

**Tasks**:
1. If PR already exists, optionally update its body
2. Add comment noting new commits
3. Handle attestation map merge

**Questions**:
- [ ] Should we update existing PR body or leave as-is?
- [ ] How to merge attestation maps if both have entries?

---

## File Structure

```
.github/
├── workflows/
│   └── format-atomic-prs.yaml    # Main workflow
└── scripts/
    └── attestation-lib.sh        # Shared functions
```

---

## Dependencies Graph

```
┌──────────────────────┐
│ Workflow 3 merges    │
│ to integration/*     │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Phase 4.1: Base      │
│ Workflow             │
└──────────┬───────────┘
           │
     ┌─────┴─────┐
     ▼           ▼
┌─────────┐ ┌─────────────┐
│Phase 4.2│ │Phase 4.3    │
│Chart    │ │Source PR    │
│Name     │ │Discovery    │
└────┬────┘ └──────┬──────┘
     │             │
     └──────┬──────┘
            ▼
┌──────────────────────┐
│ Phase 4.4: Check     │
│ Existing PR          │
└──────────┬───────────┘
           │
     ┌─────┴─────┐
     ▼           ▼
┌─────────┐ ┌─────────────┐
│Phase 4.5│ │Phase 4.6    │
│Create PR│ │Update PR    │
└─────────┘ └─────────────┘
```

---

## Open Questions

1. **PR Assignment**: Should PRs be auto-assigned to specific team/users?
2. **Labels**: What labels should be applied to these PRs?
3. **Existing PR Update**: Update body or just add commits?
4. **Lineage Depth**: How far back to trace the PR chain?
5. **Merge Conflict**: What if chart changed on main since branch creation?

---

## Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| Source PR not found | Medium | Graceful fallback, log warning |
| PR creation fails | Medium | Retry logic, error notification |
| Attestation map missing | Low | Log warning, proceed anyway |
| Multiple triggers for same push | Low | Check for existing PR first |

---

## Success Criteria

- [ ] Workflow triggers on merge to `integration/<chart>`
- [ ] Correctly extracts chart name from branch
- [ ] Finds source PR and attestation map
- [ ] Creates PR to main with correct format
- [ ] PR body contains attestation map
- [ ] PR body contains source PR references
- [ ] Handles existing PR gracefully
- [ ] Workflow completes in < 2 minutes
