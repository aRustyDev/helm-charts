# Workflow 2: Filter Charts

## Goal
Detect all charts changed in a merge to Integration and create/update per-chart branches (`integration/<chart>`) with isolated changes. Open PRs for each chart branch back to Integration.

## Trigger
```yaml
on:
  push:
    branches:
      - integration
    paths:
      - 'charts/**'
```

## Inputs

| Input | Source | Description |
|-------|--------|-------------|
| Merge Commit SHA | `github.sha` | The merge commit |
| Changed Files | `git diff` | Files changed in the merge |
| Source PR | `gh pr list` | The PR that was merged (for attestation reference) |

## Outputs

| Output | Destination | Description |
|--------|-------------|-------------|
| Chart Branches | `integration/<chart>` | Updated per-chart branches |
| PRs | GitHub PRs | `integration/<chart> -> integration` PRs |
| Source PR Reference | PR Body | Link to original PR and attestation map |

## Controls (Rulesets)

| Control | Setting |
|---------|---------|
| Integration deletion | Blocked (no bypass) |
| Integration push | Blocked (admin bypass) |

## Processes

### 1. Detect Changed Charts
```yaml
steps:
  - name: Checkout
    uses: actions/checkout@v4
    with:
      fetch-depth: 2  # Need previous commit for diff

  - name: Detect changed charts
    id: detect
    run: |
      # Get list of changed chart directories
      changed_charts=$(git diff --name-only HEAD~1 HEAD | \
        grep '^charts/' | \
        cut -d'/' -f2 | \
        sort -u)

      echo "charts=$changed_charts" >> $GITHUB_OUTPUT
      echo "Changed charts: $changed_charts"
```

### 2. Get Source PR Information
```yaml
  - name: Get source PR
    id: source-pr
    run: |
      # Find the PR that created this merge commit
      pr_number=$(gh pr list --state merged --search "${{ github.sha }}" --json number -q '.[0].number')
      pr_body=$(gh pr view $pr_number --json body -q '.body')

      echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
      echo "pr_body<<EOF" >> $GITHUB_OUTPUT
      echo "$pr_body" >> $GITHUB_OUTPUT
      echo "EOF" >> $GITHUB_OUTPUT
```

### 3. Process Each Chart
```yaml
  - name: Process charts
    run: |
      for chart in ${{ steps.detect.outputs.charts }}; do
        echo "Processing chart: $chart"

        # Create or checkout per-chart branch
        if git ls-remote --heads origin "integration/$chart" | grep -q .; then
          git fetch origin "integration/$chart"
          git checkout "integration/$chart"
          git reset --hard "integration/$chart"
        else
          git checkout -b "integration/$chart" integration
        fi

        # Checkout only this chart's files from merge commit
        git checkout ${{ github.sha }} -- "charts/$chart/"

        # Commit changes
        git add "charts/$chart/"
        if git diff --staged --quiet; then
          echo "No changes for $chart"
        else
          git commit -m "chore($chart): sync from integration

Source PR: #${{ steps.source-pr.outputs.pr_number }}"
          git push origin "integration/$chart" --force-with-lease
        fi

        # Return to integration for next iteration
        git checkout integration
      done
```

### 4. Create/Update PRs
```yaml
  - name: Create PRs
    run: |
      for chart in ${{ steps.detect.outputs.charts }}; do
        # Check if PR already exists
        existing_pr=$(gh pr list --head "integration/$chart" --base "integration" --json number -q '.[0].number')

        if [ -n "$existing_pr" ]; then
          echo "PR #$existing_pr already exists for $chart, updating..."
          # PR will auto-update with new commits
        else
          echo "Creating new PR for $chart"
          gh pr create \
            --head "integration/$chart" \
            --base "integration" \
            --title "chore($chart): atomic release preparation" \
            --body "$(cat <<EOF
## Atomic Chart Release: $chart

This PR isolates changes to the \`$chart\` chart for atomic release processing.

### Source
- PR: #${{ steps.source-pr.outputs.pr_number }}

### Attestation Map (from source)
${{ steps.source-pr.outputs.attestation_map }}

---
*Auto-generated by Workflow 2: Filter Charts*
EOF
)"
        fi
      done
```

## Shared Components Used
- `actions/checkout@v4`
- `gh` CLI for PR operations
- Git operations (checkout, commit, push)
- Attestation map extraction (from source PR)

## Error Handling
- If chart detection fails, log and exit
- If branch creation fails, retry with fresh state
- If PR creation fails, check for existing PR

## Sequence Diagram
```
┌───────────┐     ┌──────────┐     ┌──────────────────┐
│ Merge to  │     │ Workflow │     │ integration/     │
│Integration│     │    2     │     │ <chart> branches │
└─────┬─────┘     └────┬─────┘     └────────┬─────────┘
      │                │                     │
      │ Trigger        │                     │
      │───────────────►│                     │
      │                │                     │
      │                │ Detect charts       │
      │                │─────────┐           │
      │                │         │           │
      │                │◄────────┘           │
      │                │                     │
      │                │ For each chart:     │
      │                │                     │
      │                │ git checkout files  │
      │                │────────────────────►│
      │                │                     │
      │                │ Create/update branch│
      │                │────────────────────►│
      │                │                     │
      │                │ Create/update PR    │
      │                │────────────────────►│
```
