# Workflow 4: Format Atomic Chart PRs

## Goal
When changes are merged to `integration/<chart>`, automatically create a PR from that branch to `main`. Format the PR with proper references to the source PR and attestation lineage.

## Trigger
```yaml
on:
  push:
    branches:
      - 'integration/*'
```

## Inputs

| Input | Source | Description |
|-------|--------|-------------|
| Chart Branch | `github.ref` | The `integration/<chart>` branch |
| Chart Name | Extracted from branch | e.g., `cloudflared` |
| Commit SHA | `github.sha` | The merge commit |
| Source PR Chain | PR description | Original PR references |

## Outputs

| Output | Destination | Description |
|--------|-------------|-------------|
| Main PR | GitHub PRs | `integration/<chart> -> main` PR |
| PR Body | PR Description | Formatted with source references |

## Controls (Rulesets)

| Control | Setting |
|---------|---------|
| `main` requires PR | Yes |
| `main` requires review | Yes |

## Processes

### 1. Extract Chart Name
```yaml
jobs:
  create-main-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Extract chart name
        id: chart
        run: |
          # Branch is refs/heads/integration/<chart>
          BRANCH="${{ github.ref }}"
          CHART_NAME="${BRANCH#refs/heads/integration/}"
          echo "name=$CHART_NAME" >> $GITHUB_OUTPUT
          echo "Chart: $CHART_NAME"
```

### 2. Find Source PR Chain
```yaml
      - name: Get source PR chain
        id: sources
        run: |
          # Find the most recent PR that merged to this branch
          INTEGRATION_PR=$(gh pr list \
            --state merged \
            --head integration \
            --base "integration/${{ steps.chart.outputs.name }}" \
            --json number,body \
            --limit 1 \
            -q '.[0]')

          PR_NUMBER=$(echo "$INTEGRATION_PR" | jq -r '.number')
          PR_BODY=$(echo "$INTEGRATION_PR" | jq -r '.body')

          # Extract attestation map from PR body
          ATTESTATION_MAP=$(echo "$PR_BODY" | grep -ozP '<!-- ATTESTATION_MAP\n\K[^-]+' | tr -d '\0')

          # Extract original source PR (from workflow 2)
          ORIGINAL_PR=$(echo "$PR_BODY" | grep -oP 'Source PR: #\K\d+')

          echo "integration_pr=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "original_pr=$ORIGINAL_PR" >> $GITHUB_OUTPUT
          echo "attestation_map<<EOF" >> $GITHUB_OUTPUT
          echo "$ATTESTATION_MAP" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 3. Check for Existing PR
```yaml
      - name: Check for existing PR
        id: existing
        run: |
          EXISTING=$(gh pr list \
            --head "integration/${{ steps.chart.outputs.name }}" \
            --base main \
            --state open \
            --json number \
            -q '.[0].number')

          echo "pr_number=$EXISTING" >> $GITHUB_OUTPUT
          if [ -n "$EXISTING" ]; then
            echo "Existing PR found: #$EXISTING"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 4. Create or Update PR
```yaml
      - name: Create PR to main
        if: steps.existing.outputs.pr_number == ''
        run: |
          CHART="${{ steps.chart.outputs.name }}"

          gh pr create \
            --head "integration/$CHART" \
            --base main \
            --title "chore($CHART): release preparation" \
            --body "$(cat <<EOF
## Release Preparation: $CHART

This PR prepares the \`$CHART\` chart for release.

### Lineage

| Stage | PR |
|-------|-----|
| Feature → Integration | #${{ steps.sources.outputs.original_pr }} |
| Integration → integration/$CHART | #${{ steps.sources.outputs.integration_pr }} |
| integration/$CHART → main | This PR |

### Attestation Map

<!-- ATTESTATION_MAP
${{ steps.sources.outputs.attestation_map }}
-->

### Checklist

- [ ] Attestation lineage verified
- [ ] Version bump determined
- [ ] Changelog reviewed

---
*Auto-generated by Workflow 4: Format Atomic Chart PRs*
EOF
)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing PR
        if: steps.existing.outputs.pr_number != ''
        run: |
          echo "PR #${{ steps.existing.outputs.pr_number }} exists, it will auto-update with new commits"
          # Optionally update the body with new attestation map
```

## Shared Components Used
- `gh` CLI for PR operations
- Attestation map extraction
- PR body formatting template

## Error Handling
- If source PR not found, create PR with warning
- If attestation map missing, log warning but continue
- If PR creation fails, check for race condition (PR may have been created by parallel run)

## Sequence Diagram
```
┌──────────────┐     ┌──────────┐     ┌──────┐
│ integration/ │     │ Workflow │     │ main │
│ <chart>      │     │    4     │     │      │
└──────┬───────┘     └────┬─────┘     └──┬───┘
       │                  │               │
       │ Merge            │               │
       │─────────────────►│               │
       │                  │               │
       │                  │ Extract info  │
       │                  │─────────┐     │
       │                  │         │     │
       │                  │◄────────┘     │
       │                  │               │
       │                  │ Get sources   │
       │◄─────────────────│               │
       │ (PR body)        │               │
       │─────────────────►│               │
       │                  │               │
       │                  │ Create PR     │
       │                  │──────────────►│
       │                  │               │
       │                  │ PR ready      │
       │                  │──────────────►│
```
