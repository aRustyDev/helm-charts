# W7 - Atomic Chart Releases
#
# Triggered by tag push (from W6), packages the chart and generates attestations.
# The packaged chart is then used by W8 to publish.
#
# Trigger: Push of tags matching *-v[0-9]* (e.g., cloudflared-v0.4.1)
#
# This workflow:
#   1. Extracts chart name and version from tag
#   2. Validates tag matches Chart.yaml version
#   3. Builds chart package with `helm package`
#   4. Generates build attestation
#   5. Uploads package artifact for W8
#
# See: .claude/plans/chart-release-workflows/workflow-7/plan.md

name: W7 - Atomic Chart Releases

on:
  push:
    tags:
      - '*-v[0-9]*'

permissions:
  contents: read
  id-token: write
  attestations: write

concurrency:
  group: w7-release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  package-chart:
    runs-on: ubuntu-latest
    outputs:
      chart: ${{ steps.parse-tag.outputs.chart }}
      version: ${{ steps.parse-tag.outputs.version }}
      tag: ${{ steps.parse-tag.outputs.tag }}
      package_name: ${{ steps.build-package.outputs.package_name }}
      digest: ${{ steps.build-package.outputs.digest }}
    steps:
      - name: Parse Tag
        id: parse-tag
        run: |
          TAG="${{ github.ref_name }}"
          echo "::notice::Processing tag: $TAG"

          # Parse tag format: <chart>-v<version>
          # Examples: cloudflared-v0.4.1, my-chart-v1.2.3-beta.1
          if [[ ! "$TAG" =~ ^([a-z0-9-]+)-v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            echo "::error::Invalid tag format: $TAG"
            echo "::error::Expected format: <chart>-v<version> (e.g., cloudflared-v0.4.1)"
            exit 1
          fi

          CHART="${BASH_REMATCH[1]}"
          VERSION="${BASH_REMATCH[2]}"

          echo "chart=$CHART" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          echo "::notice::Chart: $CHART"
          echo "::notice::Version: $VERSION"

      - name: Checkout Tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Validate Chart
        run: |
          CHART="${{ steps.parse-tag.outputs.chart }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"

          CHART_YAML="charts/$CHART/Chart.yaml"

          # Verify chart directory exists
          if [[ ! -d "charts/$CHART" ]]; then
            echo "::error::Chart directory not found: charts/$CHART"
            exit 1
          fi

          # Verify Chart.yaml exists
          if [[ ! -f "$CHART_YAML" ]]; then
            echo "::error::Chart.yaml not found: $CHART_YAML"
            exit 1
          fi

          # Verify version matches
          CHART_VERSION=$(grep '^version:' "$CHART_YAML" | awk '{print $2}' | tr -d '"' | tr -d "'")
          if [[ "$CHART_VERSION" != "$VERSION" ]]; then
            echo "::error::Version mismatch!"
            echo "::error::  Tag version: $VERSION"
            echo "::error::  Chart.yaml version: $CHART_VERSION"
            exit 1
          fi

          echo "::notice::Validated: Chart.yaml version matches tag ($VERSION)"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Build Chart Package
        id: build-package
        run: |
          CHART="${{ steps.parse-tag.outputs.chart }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"

          mkdir -p .cr-release-packages

          echo "::group::Building chart package"
          helm package "charts/$CHART" -d .cr-release-packages/
          echo "::endgroup::"

          PACKAGE_NAME="${CHART}-${VERSION}.tgz"
          PACKAGE_FILE=".cr-release-packages/$PACKAGE_NAME"

          if [[ ! -f "$PACKAGE_FILE" ]]; then
            echo "::error::Package file not created: $PACKAGE_FILE"
            exit 1
          fi

          # Calculate digest
          DIGEST=$(sha256sum "$PACKAGE_FILE" | cut -d' ' -f1)

          echo "::notice::Package built: $PACKAGE_FILE"
          echo "::notice::Digest: sha256:$DIGEST"

          echo "package=$PACKAGE_FILE" >> "$GITHUB_OUTPUT"
          echo "package_name=$PACKAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Generate Build Attestation
        id: build-attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ${{ steps.build-package.outputs.package }}

      - name: Upload Chart Package
        uses: actions/upload-artifact@v4
        with:
          name: chart-package-${{ steps.parse-tag.outputs.chart }}-${{ steps.parse-tag.outputs.version }}
          path: ${{ steps.build-package.outputs.package }}
          retention-days: 7

      - name: Summary
        run: |
          {
            echo "## W7 - Atomic Chart Releases Summary"
            echo ""
            echo "### Chart Information"
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| **Chart** | \`${{ steps.parse-tag.outputs.chart }}\` |"
            echo "| **Version** | \`${{ steps.parse-tag.outputs.version }}\` |"
            echo "| **Tag** | \`${{ steps.parse-tag.outputs.tag }}\` |"
            echo "| **Package** | \`${{ steps.build-package.outputs.package_name }}\` |"
            echo "| **Digest** | \`${{ steps.build-package.outputs.digest }}\` |"
            echo ""
            echo "### Build Attestation"
            echo "- Attestation generated via \`actions/attest-build-provenance\`"
            echo "- Bundle path: \`${{ steps.build-attestation.outputs.bundle-path }}\`"
            echo ""
            echo "### Next Steps"
            echo "W8 will automatically:"
            echo "1. Publish to GHCR (OCI registry)"
            echo "2. Create GitHub Release"
            echo "3. Update Helm repository index on release branch"
          } >> "$GITHUB_STEP_SUMMARY"
