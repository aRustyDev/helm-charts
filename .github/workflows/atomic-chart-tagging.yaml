name: W6 - Atomic Chart Tagging

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: w6-tagging-${{ github.sha }}
  cancel-in-progress: false

jobs:
  tag-and-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tag operations

      - name: Load secrets from 1Password
        id: op-secrets
        uses: 1password/load-secrets-action@v2
        with:
          export-env: false
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          X_REPO_AUTH_APP_ID: op://gh-shared/xauth/app/id
          X_REPO_AUTH_PRIVATE_KEY: op://gh-shared/xauth/app/private-key.pem

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ steps.op-secrets.outputs.X_REPO_AUTH_APP_ID }}
          private-key: ${{ steps.op-secrets.outputs.X_REPO_AUTH_PRIVATE_KEY }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect Changed Charts
        id: detect-charts
        run: |
          source .github/scripts/attestation-lib.sh

          # Detect charts changed in this push
          CHARTS=$(detect_changed_charts "HEAD~1..HEAD")

          if [[ -z "$CHARTS" ]]; then
            echo "::notice::No chart changes detected, skipping tagging"
            echo "charts=" >> "$GITHUB_OUTPUT"
            echo "has_charts=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "charts=$CHARTS" >> "$GITHUB_OUTPUT"
          echo "has_charts=true" >> "$GITHUB_OUTPUT"
          echo "::notice::Charts to process: $CHARTS"

      - name: Find Source PR
        id: source-pr
        if: steps.detect-charts.outputs.has_charts == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          source .github/scripts/attestation-lib.sh

          # Find merged PR for this commit
          PR_NUMBER=$(get_source_pr "${{ github.sha }}")

          if [[ -z "$PR_NUMBER" ]]; then
            echo "::warning::Could not find merged PR for commit ${{ github.sha }}"
            echo "pr_number=" >> "$GITHUB_OUTPUT"
            echo "attestation_map={}" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Found source PR: #$PR_NUMBER"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

            # Extract attestation map
            ATTESTATION_MAP=$(extract_attestation_map "$PR_NUMBER")
            echo "attestation_map=$ATTESTATION_MAP" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Tags
        id: create-tags
        if: steps.detect-charts.outputs.has_charts == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          source .github/scripts/attestation-lib.sh

          CHARTS="${{ steps.detect-charts.outputs.charts }}"
          PR_NUMBER="${{ steps.source-pr.outputs.pr_number }}"
          ATTESTATION_MAP='${{ steps.source-pr.outputs.attestation_map }}'
          COMMIT_SHA="${{ github.sha }}"

          CREATED_TAGS=""
          TAGGED_CHARTS=""
          SKIPPED_TAGS=""
          FAILED=false

          for chart in $CHARTS; do
            echo "::group::Processing chart: $chart"

            # Get version from Chart.yaml
            CHART_YAML="charts/$chart/Chart.yaml"
            if [[ ! -f "$CHART_YAML" ]]; then
              echo "::warning::Chart.yaml not found for $chart, skipping"
              echo "::endgroup::"
              continue
            fi

            VERSION=$(grep '^version:' "$CHART_YAML" | awk '{print $2}' | tr -d '"' | tr -d "'")
            if [[ -z "$VERSION" ]]; then
              echo "::error::Could not extract version from $CHART_YAML"
              FAILED=true
              echo "::endgroup::"
              continue
            fi

            TAG_NAME="${chart}-v${VERSION}"
            echo "Tag: $TAG_NAME, Version: $VERSION"

            # Check if tag already exists
            if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
              EXISTING_TAG_COMMIT=$(git rev-list -n 1 "$TAG_NAME")

              if [[ "$EXISTING_TAG_COMMIT" == "$COMMIT_SHA" ]]; then
                echo "::notice::Tag $TAG_NAME already exists and points to this commit. Skipping."
                SKIPPED_TAGS="${SKIPPED_TAGS} ${TAG_NAME}"
                echo "::endgroup::"
                continue
              else
                echo "::error::Tag $TAG_NAME already exists but points to different commit!"
                echo "::error::Existing: $EXISTING_TAG_COMMIT"
                echo "::error::Current: $COMMIT_SHA"
                echo "::error::This indicates either:"
                echo "::error::  1. Version was not bumped by W5"
                echo "::error::  2. Tag was created manually (policy violation)"
                echo "::error::  3. Unexpected race condition"
                echo "::error::Resolution: Investigate and ensure version is incremented."
                FAILED=true
                echo "::endgroup::"
                continue
              fi
            fi

            # Extract changelog for this version
            CHANGELOG=$(extract_changelog_for_version "$chart" "$VERSION")

            # Format attestation lineage
            if [[ -n "$ATTESTATION_MAP" && "$ATTESTATION_MAP" != "{}" ]]; then
              ATTESTATION_LINEAGE=$(echo "$ATTESTATION_MAP" | jq -r 'to_entries | .[] | "- \(.key): \(.value)"')
            else
              ATTESTATION_LINEAGE="- No attestation data available"
            fi

            # Create annotated tag
            git tag -a "$TAG_NAME" -m "$(cat <<EOF
          Release: $chart v$VERSION

          Attestation Lineage:
          $ATTESTATION_LINEAGE

          Changelog:
          $CHANGELOG

          Source PR: #${PR_NUMBER:-unknown}
          Commit: $COMMIT_SHA
          EOF
          )"

            echo "::notice::Created tag: $TAG_NAME"

            # Push tag using App token
            git push origin "$TAG_NAME"
            echo "::notice::Pushed tag: $TAG_NAME"

            # Track successful tags
            if [[ -z "$CREATED_TAGS" ]]; then
              CREATED_TAGS="$TAG_NAME"
            else
              CREATED_TAGS="${CREATED_TAGS}, ${TAG_NAME}"
            fi
            TAGGED_CHARTS="${TAGGED_CHARTS} ${chart}"

            echo "::endgroup::"
          done

          # Output results
          echo "created_tags=$CREATED_TAGS" >> "$GITHUB_OUTPUT"
          echo "tagged_charts=$TAGGED_CHARTS" >> "$GITHUB_OUTPUT"
          echo "skipped_tags=$SKIPPED_TAGS" >> "$GITHUB_OUTPUT"

          if [[ "$FAILED" == "true" ]]; then
            echo "::error::One or more tags failed to create"
            exit 1
          fi

          if [[ -z "$CREATED_TAGS" && -z "$SKIPPED_TAGS" ]]; then
            echo "::warning::No tags were created or skipped"
          fi

      - name: Create or Update Release PR
        if: steps.create-tags.outputs.created_tags != ''
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          CREATED_TAGS="${{ steps.create-tags.outputs.created_tags }}"

          # Check for existing release PR (main -> release)
          EXISTING_PR=$(gh pr list \
            --head main \
            --base release \
            --state open \
            --json number,title \
            --limit 1 \
            -q '.[0]')

          # Generate PR body
          generate_pr_body() {
            local tags="$1"
            cat <<EOF
          ## Release Preparation

          This PR prepares the following charts for release:

          | Tag | Created |
          |-----|---------|
          $(echo "$tags" | tr ',' '\n' | sed 's/^ *//' | while read -r tag; do
            if [[ -n "$tag" ]]; then
              echo "| $tag | $(date -u +%Y-%m-%d) |"
            fi
          done)

          ### Attestation Lineage

          All charts have been validated through the attestation pipeline.
          See individual tag annotations for full lineage:

          \`\`\`bash
          # View tag annotation
          git tag -l --format='%(contents)' <tag-name>
          \`\`\`

          ### Merge Instructions

          When this PR is merged to \`release\`:
          1. W7 will verify tag attestations and build chart packages
          2. W8 will publish to GHCR and create GitHub Releases

          ---
          *Auto-generated by W6: Atomic Chart Tagging*
          *Commit: ${{ github.sha }}*
          EOF
          }

          if [[ -n "$EXISTING_PR" ]]; then
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            OLD_TITLE=$(echo "$EXISTING_PR" | jq -r '.title')

            # Append new tags to title
            NEW_TITLE="${OLD_TITLE}, ${CREATED_TAGS}"

            gh pr edit "$PR_NUMBER" \
              --title "$NEW_TITLE" \
              --body "$(generate_pr_body "$NEW_TITLE")"

            echo "::notice::Updated existing release PR #$PR_NUMBER"
            echo "PR URL: https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
          else
            # Create new PR
            PR_URL=$(gh pr create \
              --head main \
              --base release \
              --title "release: $CREATED_TAGS" \
              --body "$(generate_pr_body "$CREATED_TAGS")")

            echo "::notice::Created new release PR: $PR_URL"
          fi

      - name: Cleanup Integration Branches
        if: steps.create-tags.outputs.tagged_charts != ''
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          TAGGED_CHARTS="${{ steps.create-tags.outputs.tagged_charts }}"

          for chart in $TAGGED_CHARTS; do
            BRANCH="integration/$chart"

            if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              git push origin --delete "$BRANCH"
              echo "::notice::Deleted branch: $BRANCH"
            else
              echo "::notice::Branch $BRANCH does not exist, skipping cleanup"
            fi
          done

      - name: Summary
        if: always()
        run: |
          echo "## W6 - Atomic Chart Tagging Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.detect-charts.outputs.has_charts }}" != "true" ]]; then
            echo "No chart changes detected in this push." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "### Charts Processed" >> $GITHUB_STEP_SUMMARY
          echo "- Charts: ${{ steps.detect-charts.outputs.charts }}" >> $GITHUB_STEP_SUMMARY
          echo "- Source PR: #${{ steps.source-pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ steps.create-tags.outputs.created_tags }}" ]]; then
            echo "**Created:** ${{ steps.create-tags.outputs.created_tags }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ -n "${{ steps.create-tags.outputs.skipped_tags }}" ]]; then
            echo "**Skipped (already exist):**${{ steps.create-tags.outputs.skipped_tags }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the release PR (main â†’ release)" >> $GITHUB_STEP_SUMMARY
          echo "2. Merge to trigger W7/W8 for publishing" >> $GITHUB_STEP_SUMMARY
