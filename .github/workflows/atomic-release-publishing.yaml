# W8 - Atomic Release Publishing
#
# Triggered by W7 completion, publishes the chart package to all distribution channels.
#
# Trigger: workflow_run on W7 success
#
# This workflow:
#   1. Downloads chart package artifact from W7
#   2. Publishes to GHCR (OCI registry) with Cosign signing
#   3. Creates GitHub Release with package and signature
#   4. Updates release branch with package and index.yaml
#
# See: .claude/plans/chart-release-workflows/workflow-8/plan.md

name: W8 - Atomic Release Publishing

on:
  workflow_run:
    workflows: ["W7 - Atomic Chart Releases"]
    types:
      - completed

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write
  actions: read  # Required to download artifacts from triggering workflow

concurrency:
  group: w8-publish-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  publish:
    # Only run on successful W7 completion
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      chart: ${{ steps.parse-tag.outputs.chart }}
      version: ${{ steps.parse-tag.outputs.version }}
      tag: ${{ steps.parse-tag.outputs.tag }}
      oci_url: ${{ steps.publish-ghcr.outputs.oci_url }}
      release_url: ${{ steps.create-release.outputs.release_url }}
    steps:
      - name: Parse Tag from Workflow Run
        id: parse-tag
        run: |
          # The tag is in head_branch for tag-triggered workflows
          TAG="${{ github.event.workflow_run.head_branch }}"
          echo "::notice::Processing tag from W7: $TAG"

          # Parse tag format: <chart>-v<version>
          if [[ ! "$TAG" =~ ^([a-z0-9-]+)-v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            echo "::error::Invalid tag format: $TAG"
            exit 1
          fi

          CHART="${BASH_REMATCH[1]}"
          VERSION="${BASH_REMATCH[2]}"

          echo "chart=$CHART" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          echo "::notice::Chart: $CHART, Version: $VERSION"

      - name: Download Chart Package from W7
        uses: actions/download-artifact@v4
        with:
          name: chart-package-${{ steps.parse-tag.outputs.chart }}-${{ steps.parse-tag.outputs.version }}
          path: .cr-release-packages/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Package
        id: verify-package
        run: |
          CHART="${{ steps.parse-tag.outputs.chart }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"
          PACKAGE_NAME="${CHART}-${VERSION}.tgz"
          PACKAGE_FILE=".cr-release-packages/$PACKAGE_NAME"

          if [[ ! -f "$PACKAGE_FILE" ]]; then
            echo "::error::Package not found: $PACKAGE_FILE"
            ls -la .cr-release-packages/
            exit 1
          fi

          DIGEST=$(sha256sum "$PACKAGE_FILE" | cut -d' ' -f1)

          echo "::notice::Package: $PACKAGE_FILE"
          echo "::notice::Digest: sha256:$DIGEST"

          echo "package=$PACKAGE_FILE" >> "$GITHUB_OUTPUT"
          echo "package_name=$PACKAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Load secrets from 1Password
        id: op-secrets
        uses: 1password/load-secrets-action@v2
        with:
          export-env: false
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          X_REPO_AUTH_APP_ID: op://gh-shared/xauth/app/id
          X_REPO_AUTH_PRIVATE_KEY: op://gh-shared/xauth/app/private-key.pem

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ steps.op-secrets.outputs.X_REPO_AUTH_APP_ID }}
          private-key: ${{ steps.op-secrets.outputs.X_REPO_AUTH_PRIVATE_KEY }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GHCR
        id: publish-ghcr
        run: |
          CHART="${{ steps.parse-tag.outputs.chart }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"
          PACKAGE="${{ steps.verify-package.outputs.package }}"

          # GHCR requires lowercase
          REGISTRY="ghcr.io/${{ github.repository_owner }}/charts"
          REGISTRY="${REGISTRY,,}"

          MAX_RETRIES=3
          RETRY_DELAY=5
          OCI_DIGEST=""

          for ((attempt=1; attempt<=MAX_RETRIES; attempt++)); do
            echo "::group::Pushing to GHCR (attempt $attempt/$MAX_RETRIES)"

            if PUSH_OUTPUT=$(helm push "$PACKAGE" "oci://$REGISTRY" 2>&1); then
              echo "$PUSH_OUTPUT"
              OCI_DIGEST=$(echo "$PUSH_OUTPUT" | grep -oP 'Digest: \Ksha256:[a-f0-9]+' || true)

              if [[ -n "$OCI_DIGEST" ]]; then
                echo "::notice::Pushed $CHART:$VERSION to GHCR"
                echo "::notice::OCI Digest: $OCI_DIGEST"
                echo "::endgroup::"
                break
              fi
            fi

            echo "::warning::Push attempt $attempt failed"
            echo "$PUSH_OUTPUT"
            echo "::endgroup::"

            if [[ $attempt -lt $MAX_RETRIES ]]; then
              echo "Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            else
              echo "::error::Failed to push to GHCR after $MAX_RETRIES attempts"
              exit 1
            fi
          done

          # Sign with Cosign (keyless via OIDC)
          echo "::group::Signing with Cosign"
          cosign sign --yes "$REGISTRY/$CHART@$OCI_DIGEST"
          echo "::notice::Signed $CHART@$OCI_DIGEST"
          echo "::endgroup::"

          echo "oci_digest=$OCI_DIGEST" >> "$GITHUB_OUTPUT"
          echo "oci_url=$REGISTRY/$CHART:$VERSION" >> "$GITHUB_OUTPUT"
          echo "oci_registry=$REGISTRY" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        id: create-release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          CHART="${{ steps.parse-tag.outputs.chart }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"
          TAG="${{ steps.parse-tag.outputs.tag }}"
          PACKAGE="${{ steps.verify-package.outputs.package }}"
          DIGEST="${{ steps.verify-package.outputs.digest }}"
          OCI_DIGEST="${{ steps.publish-ghcr.outputs.oci_digest }}"
          OCI_REGISTRY="${{ steps.publish-ghcr.outputs.oci_registry }}"

          # Check if release already exists
          if gh release view "$TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            echo "::notice::Release $TAG already exists, skipping creation"
            RELEASE_URL=$(gh release view "$TAG" --repo "${{ github.repository }}" --json url -q '.url')
            echo "release_url=$RELEASE_URL" >> "$GITHUB_OUTPUT"
            echo "release_exists=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Sign package blob
          echo "::group::Signing package blob"
          cosign sign-blob --yes --output-signature "${PACKAGE}.sig" "$PACKAGE"
          echo "::endgroup::"

          # Create attestation lineage file
          cat > "${CHART}-attestation-lineage.json" <<EOF
          {
            "chart": "$CHART",
            "version": "$VERSION",
            "tag": "$TAG",
            "package_digest": "$DIGEST",
            "oci_digest": "$OCI_DIGEST",
            "oci_url": "$OCI_REGISTRY/$CHART:$VERSION",
            "published_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run_id": "${{ github.event.workflow_run.id }}",
            "commit": "${{ github.event.workflow_run.head_sha }}"
          }
          EOF

          # Generate release notes
          RELEASE_NOTES=$(cat <<EOF
          ## $CHART v$VERSION

          ### Installation

          \`\`\`bash
          # Option 1: From GHCR (OCI) - Recommended
          helm install $CHART oci://$OCI_REGISTRY/$CHART --version $VERSION

          # Option 2: From Helm Repository
          helm repo add arustydev https://charts.arusty.dev
          helm repo update
          helm install $CHART arustydev/$CHART --version $VERSION
          \`\`\`

          ### Verification

          \`\`\`bash
          # Verify OCI signature with Cosign
          cosign verify $OCI_REGISTRY/$CHART@$OCI_DIGEST

          # Verify attestations
          gh attestation verify oci://$OCI_REGISTRY/$CHART:$VERSION --repo ${{ github.repository }}
          \`\`\`

          ### Checksums

          | File | SHA256 |
          |------|--------|
          | \`${CHART}-${VERSION}.tgz\` | \`${DIGEST#sha256:}\` |
          | OCI Image | \`${OCI_DIGEST}\` |

          ### Attestation Lineage

          See \`${CHART}-attestation-lineage.json\` in release assets for full attestation chain.

          ---
          *Released by W8: Atomic Release Publishing*
          EOF
          )

          # Create release with assets
          echo "::group::Creating GitHub Release"
          gh release create "$TAG" \
            --repo "${{ github.repository }}" \
            --title "$CHART v$VERSION" \
            --notes "$RELEASE_NOTES" \
            "$PACKAGE" \
            "${PACKAGE}.sig" \
            "${CHART}-attestation-lineage.json"
          echo "::endgroup::"

          RELEASE_URL=$(gh release view "$TAG" --repo "${{ github.repository }}" --json url -q '.url')
          echo "::notice::Created release: $RELEASE_URL"
          echo "release_url=$RELEASE_URL" >> "$GITHUB_OUTPUT"
          echo "release_exists=false" >> "$GITHUB_OUTPUT"

      - name: Checkout Release Branch
        uses: actions/checkout@v4
        with:
          ref: release
          path: release-branch
          token: ${{ steps.app-token.outputs.token }}

      - name: Update Release Branch
        if: steps.create-release.outputs.release_exists != 'true'
        run: |
          CHART="${{ steps.parse-tag.outputs.chart }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"
          TAG="${{ steps.parse-tag.outputs.tag }}"
          PACKAGE="${{ steps.verify-package.outputs.package }}"

          cd release-branch

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Copy package to release branch
          cp "../$PACKAGE" .

          # Update index.yaml
          # --url points to GitHub Releases download URL
          # --merge preserves existing entries
          echo "::group::Updating index.yaml"

          if [[ -f index.yaml ]]; then
            helm repo index . \
              --url "https://github.com/${{ github.repository }}/releases/download/$TAG" \
              --merge index.yaml
          else
            helm repo index . \
              --url "https://github.com/${{ github.repository }}/releases/download/$TAG"
          fi

          # Show changes
          git diff index.yaml || true
          echo "::endgroup::"

          # Commit and push
          git add index.yaml "${CHART}-${VERSION}.tgz"
          git commit -m "chore(release): publish $CHART v$VERSION

          Tag: $TAG
          Release: https://github.com/${{ github.repository }}/releases/tag/$TAG
          OCI: ${{ steps.publish-ghcr.outputs.oci_url }}"

          git push origin release

          echo "::notice::Updated release branch with $CHART v$VERSION"

      - name: Summary
        if: always()
        run: |
          {
            echo "## W8 - Atomic Release Publishing Summary"
            echo ""
            echo "### Chart Information"
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| **Chart** | \`${{ steps.parse-tag.outputs.chart }}\` |"
            echo "| **Version** | \`${{ steps.parse-tag.outputs.version }}\` |"
            echo "| **Tag** | \`${{ steps.parse-tag.outputs.tag }}\` |"
            echo ""
            echo "### Distribution Channels"
            echo "| Channel | URL |"
            echo "|---------|-----|"
            echo "| **GHCR (OCI)** | \`${{ steps.publish-ghcr.outputs.oci_url }}\` |"
            echo "| **GitHub Release** | ${{ steps.create-release.outputs.release_url }} |"
            echo "| **Helm Repo** | \`helm repo add arustydev https://charts.arusty.dev\` |"
            echo ""
            echo "### Security"
            echo "| Item | Status |"
            echo "|------|--------|"
            echo "| OCI Signature (Cosign) | :white_check_mark: Signed |"
            echo "| Package Signature (.sig) | :white_check_mark: Signed |"
            echo "| Attestation Lineage | :white_check_mark: Included |"
            echo ""
            echo "### Verification Commands"
            echo "\`\`\`bash"
            echo "# Verify OCI signature"
            echo "cosign verify ${{ steps.publish-ghcr.outputs.oci_url }}"
            echo ""
            echo "# Verify attestations"
            echo "gh attestation verify oci://${{ steps.publish-ghcr.outputs.oci_url }} --repo ${{ github.repository }}"
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"

  # Handle W7 failure
  notify-failure:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: W7 Failed
        run: |
          echo "::error::W7 workflow failed. W8 publishing skipped."
          echo "::error::Check W7 run: ${{ github.event.workflow_run.html_url }}"

          {
            echo "## W8 - Atomic Release Publishing"
            echo ""
            echo ":x: **Skipped** - W7 workflow failed"
            echo ""
            echo "Check the [W7 workflow run](${{ github.event.workflow_run.html_url }}) for details."
          } >> "$GITHUB_STEP_SUMMARY"
