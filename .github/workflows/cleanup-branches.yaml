name: Cleanup Orphan Branches

on:
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (list branches without deleting)'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write

jobs:
  cleanup:
    name: Cleanup Orphan Branches
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Find and cleanup orphan branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
        run: |
          echo "ðŸ” Scanning for orphan branches..."

          # Protected branches that should never be deleted
          PROTECTED_BRANCHES="main charts"

          # Patterns for branches that should be cleaned up if orphaned
          CLEANUP_PATTERNS=(
            "release-please--"
            "dependabot/"
          )

          # Get all remote branches
          git fetch --prune
          BRANCHES=$(git branch -r | grep -v HEAD | sed 's/origin\///' | tr -d ' ')

          ORPHANS=()

          for branch in $BRANCHES; do
            # Skip protected branches
            if echo "$PROTECTED_BRANCHES" | grep -qw "$branch"; then
              continue
            fi

            # Check if branch matches cleanup patterns
            MATCHES_PATTERN=false
            for pattern in "${CLEANUP_PATTERNS[@]}"; do
              if [[ "$branch" == $pattern* ]]; then
                MATCHES_PATTERN=true
                break
              fi
            done

            if [ "$MATCHES_PATTERN" = false ]; then
              continue
            fi

            # Check if there's an open PR for this branch
            PR_COUNT=$(gh pr list --head "$branch" --state open --json number --jq 'length')

            if [ "$PR_COUNT" -eq 0 ]; then
              # Check branch age (older than 7 days with no open PR)
              LAST_COMMIT_DATE=$(git log -1 --format=%ct "origin/$branch" 2>/dev/null || echo "0")
              CURRENT_DATE=$(date +%s)
              AGE_DAYS=$(( (CURRENT_DATE - LAST_COMMIT_DATE) / 86400 ))

              if [ "$AGE_DAYS" -gt 7 ]; then
                echo "ðŸ“Œ Found orphan: $branch (age: ${AGE_DAYS} days, no open PR)"
                ORPHANS+=("$branch")
              fi
            fi
          done

          if [ ${#ORPHANS[@]} -eq 0 ]; then
            echo "âœ… No orphan branches found"
            exit 0
          fi

          echo ""
          echo "ðŸ“‹ Orphan branches found: ${#ORPHANS[@]}"
          for branch in "${ORPHANS[@]}"; do
            echo "  - $branch"
          done

          if [ "$DRY_RUN" = "true" ]; then
            echo ""
            echo "ðŸ”’ DRY RUN - No branches deleted"
            echo "Run with dry_run=false to delete these branches"
          else
            echo ""
            echo "ðŸ—‘ï¸ Deleting orphan branches..."
            for branch in "${ORPHANS[@]}"; do
              echo "  Deleting: $branch"
              git push origin --delete "$branch" || echo "    âš ï¸ Failed to delete $branch"
            done
            echo "âœ… Cleanup complete"
          fi

      - name: Summary
        run: |
          echo "## Branch Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** ${{ github.event.inputs.dry_run == 'false' && 'Delete' || 'Dry Run' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
