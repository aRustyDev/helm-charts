# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
#
# Workflow 2: Create Atomic Chart PRs
#
# When changes are merged to the integration branch, this workflow
# atomizes those changes into per-chart PRs targeting main.
#
# Calls reusable workflow from aRustyDev/gh.
#
# Flow:
#   Merge to integration -> Detect changed charts -> Create per-chart branches -> Open PRs to main
#
# See: .claude/plans/chart-release-workflows/workflow-2/plan.md

name: Create Atomic Chart PR

on:
  push:
    branches:
      - integration
    paths:
      - 'charts/**'

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip PR creation)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  id-token: write
  attestations: write

# NOTE: Concurrency is handled by the reusable workflow
# Do not add concurrency here - it causes a deadlock with the reusable workflow's concurrency

jobs:
  atomize:
    uses: aRustyDev/gh/.github/workflows/atomic-release-atomize-changes.yml@atomic-release-v0.1.1
    with:
      artifact_path: "charts"
      manifest_file: "Chart.yaml"
      branch_prefix: "charts"
      target_branch: "main"
      source_branch: "integration"
      trigger_validation: "chart-pr-created"
      dry_run: ${{ github.event.inputs.dry_run == 'true' }}
