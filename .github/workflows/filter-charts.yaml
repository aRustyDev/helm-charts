# Workflow 2: Filter Charts
#
# Detects charts changed in the integration branch and creates per-chart
# branches for atomic processing with PRs to main.
#
# Trigger: Push to integration branch with changes to charts/**
#
# Jobs:
#   - detect-changes: Identify changed charts and source PR
#   - process-charts: Create/update per-chart branches and PRs to main
#
# Each processed chart gets:
#   - A dedicated `charts/<chart>` branch
#   - A PR to main with the attestation map from the source PR
#
# See: .claude/plans/chart-release-workflows/workflow-2/plan.md

name: W2 - Filter Charts

on:
  push:
    branches:
      - integration
    paths:
      - 'charts/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no PR creation)'
        required: false
        default: false
        type: boolean

# Permissions required for branch operations, PR creation, and attestations
permissions:
  contents: write
  pull-requests: write
  id-token: write
  attestations: write

# Prevent concurrent runs to avoid branch conflicts
concurrency:
  group: w2-filter-charts
  cancel-in-progress: false

env:
  TARGET_BRANCH: main

jobs:
  #############################################################################
  # Detect Changes and Source PR
  #############################################################################
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.detect.outputs.charts }}
      charts_json: ${{ steps.detect.outputs.charts_json }}
      charts_count: ${{ steps.detect.outputs.charts_count }}
      source_pr: ${{ steps.source.outputs.pr_number }}
      attestation_map: ${{ steps.source.outputs.attestation_map }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed charts
        id: detect
        run: |
          source .github/scripts/attestation-lib.sh

          # Handle both squash merges and merge commits
          if git rev-parse HEAD^2 >/dev/null 2>&1; then
            # Merge commit - compare against first parent
            RANGE="HEAD^..HEAD"
            echo "::notice::Detected merge commit, using range: $RANGE"
          else
            # Squash merge or regular commit
            RANGE="HEAD~1..HEAD"
            echo "::notice::Detected squash/regular commit, using range: $RANGE"
          fi

          # Get changed charts, filtering out non-chart files
          CHARTS=""
          for dir in $(git diff --name-only "$RANGE" | grep '^charts/' | cut -d'/' -f2 | sort -u); do
            # Only include if it's an actual chart (has Chart.yaml)
            if [[ -f "charts/$dir/Chart.yaml" ]]; then
              CHARTS="$CHARTS $dir"
            else
              echo "::notice::Skipping $dir - not a chart (no Chart.yaml)"
            fi
          done

          CHARTS=$(echo "$CHARTS" | xargs)  # Trim whitespace
          CHARTS_COUNT=$(echo "$CHARTS" | wc -w | xargs)

          if [[ -z "$CHARTS" ]]; then
            echo "::notice::No chart changes detected"
            echo "charts=" >> "$GITHUB_OUTPUT"
            echo "charts_json=[]" >> "$GITHUB_OUTPUT"
            echo "charts_count=0" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Changed charts: $CHARTS"
            echo "charts=$CHARTS" >> "$GITHUB_OUTPUT"

            # Convert to JSON array for matrix
            CHARTS_JSON=$(echo "$CHARTS" | tr ' ' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "charts_json=$CHARTS_JSON" >> "$GITHUB_OUTPUT"
            echo "charts_count=$CHARTS_COUNT" >> "$GITHUB_OUTPUT"
          fi

      - name: Find source PR
        id: source
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          source .github/scripts/attestation-lib.sh

          # Try to find the source PR
          SOURCE_PR=$(get_source_pr HEAD)

          if [[ -z "$SOURCE_PR" ]]; then
            echo "::warning::Could not find source PR for commit"
            echo "pr_number=" >> "$GITHUB_OUTPUT"
            echo "attestation_map={}" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Source PR: #$SOURCE_PR"
            echo "pr_number=$SOURCE_PR" >> "$GITHUB_OUTPUT"

            # Extract attestation map from source PR
            ATTESTATION_MAP=$(extract_attestation_map "$SOURCE_PR")

            if [[ "$ATTESTATION_MAP" == "{}" || -z "$ATTESTATION_MAP" ]]; then
              echo "::warning::Source PR #$SOURCE_PR has no attestation map"
              echo "attestation_map={}" >> "$GITHUB_OUTPUT"
            else
              ENTRY_COUNT=$(echo "$ATTESTATION_MAP" | jq 'keys | length')
              echo "::notice::Found attestation map with $ENTRY_COUNT entries"
              # Escape for GitHub output
              ATTESTATION_MAP_ESCAPED=$(echo "$ATTESTATION_MAP" | jq -c .)
              echo "attestation_map=$ATTESTATION_MAP_ESCAPED" >> "$GITHUB_OUTPUT"
            fi
          fi

  #############################################################################
  # Process Each Chart (Branch + PR)
  #############################################################################
  process-charts:
    name: Process ${{ matrix.chart }}
    needs: detect-changes
    if: needs.detect-changes.outputs.charts_count != '0'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts_json) }}
      fail-fast: false
    outputs:
      # Collect results for summary (matrix outputs are tricky, handled in summary job)
      result: ${{ steps.result.outputs.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use GITHUB_TOKEN which should have push access via ruleset bypass
          token: ${{ github.token }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create/update chart branch
        id: branch
        env:
          CHART: ${{ matrix.chart }}
          SOURCE_PR: ${{ needs.detect-changes.outputs.source_pr }}
          ATTESTATION_MAP: ${{ needs.detect-changes.outputs.attestation_map }}
        run: |
          set -e
          BRANCH="charts/$CHART"

          echo "::group::Branch operations for $CHART"

          # Check if branch exists remotely
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "::notice::Branch $BRANCH exists, fetching..."
            git fetch origin "$BRANCH"

            # Check if we need to update
            LOCAL_CHART_SHA=$(git rev-parse HEAD:"charts/$CHART" 2>/dev/null || echo "none")
            REMOTE_CHART_SHA=$(git rev-parse "origin/$BRANCH:charts/$CHART" 2>/dev/null || echo "none")

            if [[ "$LOCAL_CHART_SHA" == "$REMOTE_CHART_SHA" ]]; then
              echo "::notice::No changes to push for $CHART (already up to date)"
              echo "updated=false" >> "$GITHUB_OUTPUT"
              echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
              echo "::endgroup::"
              exit 0
            fi

            # Reset branch to track remote, then update
            git checkout -B "$BRANCH" "origin/$BRANCH"
          else
            echo "::notice::Creating new branch: $BRANCH from origin/main"
            git checkout -b "$BRANCH" origin/main
          fi

          # Copy the chart directory from the integration branch commit
          git checkout "${{ github.sha }}" -- "charts/$CHART/"

          # Check if there are changes to commit
          if git diff --cached --quiet && git diff --quiet; then
            echo "::notice::No changes to commit for $CHART"
            echo "updated=false" >> "$GITHUB_OUTPUT"
            echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
            echo "::endgroup::"
            exit 0
          fi

          # Stage and commit
          git add "charts/$CHART/"

          # Create commit message with source PR reference
          COMMIT_MSG="chore($CHART): sync from integration"
          if [[ -n "$SOURCE_PR" ]]; then
            COMMIT_MSG="${COMMIT_MSG}"$'\n\n'"Source-PR: #${SOURCE_PR}"
          fi

          git commit -m "$COMMIT_MSG"

          # Push with retry logic
          MAX_RETRIES=3
          for ((i=1; i<=MAX_RETRIES; i++)); do
            if git push origin "$BRANCH" --force-with-lease; then
              echo "::notice::Successfully pushed $BRANCH"
              echo "updated=true" >> "$GITHUB_OUTPUT"
              echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
              break
            fi

            if [[ $i -eq $MAX_RETRIES ]]; then
              echo "::error::Failed to push $BRANCH after $MAX_RETRIES attempts"
              exit 1
            fi

            echo "::warning::Push failed, retrying ($i/$MAX_RETRIES)..."
            git fetch origin "$BRANCH"
            git rebase "origin/$BRANCH" || git rebase --abort
            sleep $((i * 2))
          done

          echo "::endgroup::"

      - name: Create/update PR to main
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
          CHART: ${{ matrix.chart }}
          SOURCE_PR: ${{ needs.detect-changes.outputs.source_pr }}
          ATTESTATION_MAP: ${{ needs.detect-changes.outputs.attestation_map }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          BRANCH="charts/$CHART"

          echo "::group::PR operations for $CHART"

          # Check for existing PR
          EXISTING_PR=$(gh pr list --head "$BRANCH" --base "$TARGET_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          # Build PR body using printf for proper formatting
          {
            echo "## Chart: $CHART"
            echo ""
            echo "Promoting changes from integration branch to main."
            echo ""
            echo "### Source"
            if [[ -n "$SOURCE_PR" ]]; then
              echo "- Source PR: #$SOURCE_PR"
            else
              echo "- Source PR: _(not found)_"
            fi
            echo "- Source Branch: integration"
            echo "- Source Commit: \`$COMMIT_SHA\`"
            echo ""
            echo "### Attestation Lineage"
            echo "This PR carries forward the attestation chain from the source PR."
            echo ""
            echo "<!-- ATTESTATION_MAP"
            echo "$ATTESTATION_MAP"
            echo "-->"
            echo ""
            echo "---"
            echo "*This PR was automatically created by W2 - Filter Charts workflow.*"
          } > pr_body.md

          PR_BODY=$(cat pr_body.md)

          if [[ -n "$EXISTING_PR" ]]; then
            echo "::notice::Updating existing PR #$EXISTING_PR for $CHART"
            gh pr edit "$EXISTING_PR" --body "$PR_BODY"
            echo "pr_number=$EXISTING_PR" >> "$GITHUB_OUTPUT"
            echo "pr_action=updated" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Creating new PR for $CHART"
            # Create PR (without labels - add labels manually if needed)
            NEW_PR=$(gh pr create \
              --head "$BRANCH" \
              --base "$TARGET_BRANCH" \
              --title "chore($CHART): promote to main" \
              --body "$PR_BODY" 2>&1 || true)

            # Extract PR number from URL or error
            if [[ "$NEW_PR" =~ github.com/.*/pull/([0-9]+) ]]; then
              PR_NUM="${BASH_REMATCH[1]}"
              echo "::notice::Created PR #$PR_NUM"
              echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
              echo "pr_action=created" >> "$GITHUB_OUTPUT"
            else
              # Check if PR already exists (race condition)
              EXISTING_PR=$(gh pr list --head "$BRANCH" --base "$TARGET_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
              if [[ -n "$EXISTING_PR" ]]; then
                echo "::notice::PR #$EXISTING_PR already exists (race condition)"
                gh pr edit "$EXISTING_PR" --body "$PR_BODY"
                echo "pr_number=$EXISTING_PR" >> "$GITHUB_OUTPUT"
                echo "pr_action=updated" >> "$GITHUB_OUTPUT"
              else
                echo "::error::Failed to create PR: $NEW_PR"
                echo "pr_number=" >> "$GITHUB_OUTPUT"
                echo "pr_action=failed" >> "$GITHUB_OUTPUT"
              fi
            fi
          fi

          echo "::endgroup::"

      - name: Set result
        id: result
        env:
          CHART: ${{ matrix.chart }}
          BRANCH_UPDATED: ${{ steps.branch.outputs.updated }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          PR_ACTION: ${{ steps.pr.outputs.pr_action }}
        run: |
          if [[ -n "$PR_NUMBER" ]]; then
            echo "status=success:$CHART:$PR_NUMBER:$PR_ACTION" >> "$GITHUB_OUTPUT"
          else
            echo "status=failed:$CHART::" >> "$GITHUB_OUTPUT"
          fi

  #############################################################################
  # Generate Attestation and Summary
  #############################################################################
  finalize:
    name: Finalize
    needs: [detect-changes, process-charts]
    if: always() && needs.detect-changes.outputs.charts_count != '0'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate W2 attestation
        id: digest
        env:
          CHARTS: ${{ needs.detect-changes.outputs.charts }}
          SOURCE_PR: ${{ needs.detect-changes.outputs.source_pr }}
        run: |
          # Create subject content for attestation
          SUBJECT_CONTENT=$(cat <<EOF
          {
            "workflow": "W2-filter-charts",
            "source_pr": "$SOURCE_PR",
            "charts_processed": "$CHARTS",
            "source_commit": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          )

          # Generate digest
          DIGEST=$(echo -n "$SUBJECT_CONTENT" | sha256sum | cut -d' ' -f1)
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Create attestation
        id: attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "w2-filter-charts"
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: false

      - name: Generate summary
        env:
          CHARTS: ${{ needs.detect-changes.outputs.charts }}
          SOURCE_PR: ${{ needs.detect-changes.outputs.source_pr }}
          ATTESTATION_ID: ${{ steps.attestation.outputs.attestation-id }}
        run: |
          echo "## W2 - Filter Charts Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Source" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          if [[ -n "$SOURCE_PR" ]]; then
            echo "- **Source PR**: #$SOURCE_PR" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Source PR**: _(not found)_" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Charts Processed" >> $GITHUB_STEP_SUMMARY
          echo "| Chart | Branch | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          for chart in $CHARTS; do
            echo "| $chart | \`charts/$chart\` | :white_check_mark: Processed |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Attestation" >> $GITHUB_STEP_SUMMARY
          echo "- **W2 Attestation ID**: \`$ATTESTATION_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*PRs to main have been created/updated for each chart.*" >> $GITHUB_STEP_SUMMARY

  #############################################################################
  # Handle no-change scenario
  #############################################################################
  no-changes:
    name: No Changes
    needs: detect-changes
    if: needs.detect-changes.outputs.charts_count == '0'
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## W2 - Filter Charts Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":information_source: No chart changes detected in this push." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "- Changes were made to non-chart files in the charts/ directory" >> $GITHUB_STEP_SUMMARY
          echo "- The charts/ path filter matched but no actual chart directories changed" >> $GITHUB_STEP_SUMMARY
