name: Publish Charts to GHCR

on:
  workflow_dispatch:
    inputs:
      charts:
        description: 'Charts to publish (comma-separated, or "all")'
        required: true
        default: 'all'
        type: string
      sign:
        description: 'Sign with Cosign'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set registry (lowercase for OCI)
        run: |
          echo "REGISTRY=ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/charts" >> $GITHUB_ENV

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Cosign
        if: inputs.sign
        uses: sigstore/cosign-installer@v3

      - name: Publish and sign charts to GHCR
        run: |
          CHARTS_INPUT="${{ inputs.charts }}"
          SIGN="${{ inputs.sign }}"

          if [ "$CHARTS_INPUT" = "all" ]; then
            CHART_DIRS=$(find charts -maxdepth 1 -mindepth 1 -type d)
          else
            CHART_DIRS=""
            IFS=',' read -ra CHART_NAMES <<< "$CHARTS_INPUT"
            for name in "${CHART_NAMES[@]}"; do
              name=$(echo "$name" | xargs)  # trim whitespace
              if [ -d "charts/$name" ]; then
                CHART_DIRS="$CHART_DIRS charts/$name"
              else
                echo "Warning: Chart 'charts/$name' not found, skipping"
              fi
            done
          fi

          mkdir -p .cr-release-packages

          for chart in $CHART_DIRS; do
            if [ -f "$chart/Chart.yaml" ]; then
              # Get chart name from Chart.yaml (not directory name)
              chart_name=$(grep '^name:' "$chart/Chart.yaml" | awk '{print $2}')
              version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}')
              echo "ðŸ“¦ Packaging $chart_name:$version..."
              helm package "$chart" -d .cr-release-packages/

              echo "ðŸš€ Pushing $chart_name:$version to GHCR..."
              push_output=$(helm push ".cr-release-packages/${chart_name}-${version}.tgz" oci://$REGISTRY 2>&1)
              echo "$push_output"

              # Extract digest from helm push output (format: "Digest: sha256:...")
              digest=$(echo "$push_output" | grep -oP 'Digest: \Ksha256:[a-f0-9]+')
              echo "âœ… Published $chart_name:$version (digest: $digest)"

              # Sign by digest (not tag) for security
              if [ "$SIGN" = "true" ] && [ -n "$digest" ]; then
                echo "ðŸ” Signing $REGISTRY/${chart_name}@${digest}..."
                cosign sign --yes "$REGISTRY/${chart_name}@${digest}"
                echo "âœ… Signed $chart_name:$version"
              fi
            fi
          done

      - name: Summary
        run: |
          echo "## Charts Published to GHCR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Chart | Version | Signed |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          for chart in charts/*/; do
            if [ -f "$chart/Chart.yaml" ]; then
              chart_name=$(grep '^name:' "$chart/Chart.yaml" | awk '{print $2}')
              version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}')
              signed="${{ inputs.sign }}"
              echo "| $chart_name | $version | $signed |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Registry: \`$REGISTRY\`" >> $GITHUB_STEP_SUMMARY
