# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
#
# Release Atomic Chart (W6)
#
# Tag-based workflow for packaging and publishing Helm charts.
# Triggered when chart tags are pushed (<chart>-v<version>).
#
# Calls reusable workflow from aRustyDev/gh for generic release logic,
# plus local Helm-specific jobs (update release branch).
#
# Tags are created by:
#   - W6-tag workflow (tag-atomic-chart.yaml)
#   - Manual tagging for hotfixes

name: Release Atomic Chart

on:
  push:
    tags:
      - '*-v*'  # Matches: cloudflared-v0.1.0, test-workflow-v1.2.3, etc.

  # Manual trigger via GitHub API with App token (more secure than workflow_dispatch)
  repository_dispatch:
    types: [release-chart]

permissions:
  contents: write
  packages: write
  pull-requests: write
  id-token: write
  attestations: write

concurrency:
  group: chart-release-${{ github.event_name == 'repository_dispatch' && github.event.client_payload.tag || github.ref_name }}
  cancel-in-progress: false

jobs:
  #############################################################################
  # Generic Release (via reusable workflow)
  #############################################################################
  release:
    uses: aRustyDev/gh/.github/workflows/atomic-release-publish-release.yml@atomic-release-v0.1.0
    with:
      artifact_path: "charts"
      manifest_file: "Chart.yaml"
      tag_pattern: "*-v*"
      build_command: "helm package charts/$ARTIFACT -d .release-packages/"
      publish_command: "helm push .release-packages/$ARTIFACT-$VERSION.tgz oci://ghcr.io/${REPO,,}"
      package_glob: ".release-packages/*.tgz"
      enable_cosign: true
      create_github_release: true
      github_app_id_secret_ref: "op://gh-shared/xauth/app/id"
      github_app_key_secret_ref: "op://gh-shared/xauth/app/private-key.pem"
    secrets:
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

  #############################################################################
  # Helm-Specific: Update Release Branch
  #############################################################################
  update-release-branch:
    needs: release
    if: needs.release.outputs.artifact != ''
    runs-on: ubuntu-latest
    steps:
      - name: Load secrets from 1Password
        id: op-secrets
        uses: 1password/load-secrets-action@v3
        with:
          export-env: false
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          X_REPO_AUTH_APP_ID: op://gh-shared/xauth/app/id
          X_REPO_AUTH_PRIVATE_KEY: op://gh-shared/xauth/app/private-key.pem

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ steps.op-secrets.outputs.X_REPO_AUTH_APP_ID }}
          private-key: ${{ steps.op-secrets.outputs.X_REPO_AUTH_PRIVATE_KEY }}

      - name: Checkout Release Branch
        uses: actions/checkout@v4
        with:
          ref: release
          token: ${{ steps.app-token.outputs.token }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Download Package from Release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ARTIFACT: ${{ needs.release.outputs.artifact }}
          VERSION: ${{ needs.release.outputs.version }}
        run: |
          TAG="${ARTIFACT}-v${VERSION}"
          PACKAGE_NAME="${ARTIFACT}-${VERSION}.tgz"

          echo "::group::Downloading package from release"
          gh release download "$TAG" \
            --repo "${{ github.repository }}" \
            --pattern "$PACKAGE_NAME" \
            --dir .
          echo "::endgroup::"

          if [[ ! -f "$PACKAGE_NAME" ]]; then
            echo "::error::Package not found: $PACKAGE_NAME"
            exit 1
          fi

          echo "::notice::Downloaded $PACKAGE_NAME"

      - name: Update Release Branch
        env:
          ARTIFACT: ${{ needs.release.outputs.artifact }}
          VERSION: ${{ needs.release.outputs.version }}
        run: |
          TAG="${ARTIFACT}-v${VERSION}"
          PACKAGE_NAME="${ARTIFACT}-${VERSION}.tgz"

          echo "::group::Updating release branch"

          # Update index.yaml
          if [[ -f index.yaml ]]; then
            helm repo index . \
              --url "https://github.com/${{ github.repository }}/releases/download/$TAG" \
              --merge index.yaml
          else
            helm repo index . \
              --url "https://github.com/${{ github.repository }}/releases/download/$TAG"
          fi

          echo "::endgroup::"

          # Show changes
          echo "::group::Index changes"
          git diff index.yaml || true
          echo "::endgroup::"

          # Commit and push
          git add index.yaml "$PACKAGE_NAME"
          git commit -m "chore(release): publish $ARTIFACT v$VERSION

          Tag: $TAG
          Workflow: ${{ github.run_id }}
          Commit: ${{ github.sha }}" || echo "No changes to commit"

          git push origin release

          echo "::notice::Updated release branch with $ARTIFACT v$VERSION"
