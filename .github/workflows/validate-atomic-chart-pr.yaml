# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
#
# Validate Atomic Chart PR (W5)
#
# Validates chart PRs from charts/<chart> branches and automatically
# bumps versions based on conventional commits.
#
# Calls reusable workflow from aRustyDev/gh for generic validation,
# plus local Helm-specific jobs (K8s matrix testing, ArtifactHub lint).
#
# Trigger: Pull requests to main from charts/* or integration/* branches
#
# See: .claude/plans/chart-release-workflows/workflow-5/plan.md

name: Validate Atomic Chart PR

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
    # Note: No path filter - skip jobs handle non-chart PRs to satisfy required checks

  # Triggered by W2 after creating a chart PR
  repository_dispatch:
    types: [chart-pr-created]

  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to validate (required for dispatch)'
        required: false
        type: string
      test_all:
        description: 'Test all charts (not just changed)'
        required: false
        default: 'false'
        type: boolean
      skip_version_bump:
        description: 'Skip version bump (for manual testing)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write
  id-token: write
  attestations: write

concurrency:
  group: w5-validate-${{ github.event.pull_request.number || github.event.client_payload.pr || github.run_id }}
  cancel-in-progress: false

jobs:
  #############################################################################
  # Generic Validation (via reusable workflow)
  #############################################################################
  validate:
    if: github.event.action != 'closed'
    uses: aRustyDev/gh/.github/workflows/atomic-release-validate-atomic-pr.yml@atomic-release-v0.1.0
    with:
      artifact_path: "charts"
      manifest_file: "Chart.yaml"
      branch_pattern: "charts/*"
      target_branch: "main"
      lint_command: "ct lint --config ct.yaml --target-branch main"
      enable_version_bump: ${{ github.event.inputs.skip_version_bump != 'true' }}
      cliff_config: ".github/cliff.toml"
      github_app_id_secret_ref: "op://gh-shared/xauth/app/id"
      github_app_key_secret_ref: "op://gh-shared/xauth/app/private-key.pem"
    secrets:
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

  #############################################################################
  # Helm-Specific: ArtifactHub Lint
  #############################################################################
  artifacthub-lint:
    name: artifacthub-lint
    needs: validate
    if: |
      always() &&
      needs.validate.result == 'success' &&
      needs.validate.outputs.artifact != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ArtifactHub CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          AH_VERSION=$(gh api repos/artifacthub/hub/releases/latest --jq '.tag_name' | sed 's/^v//')
          if [[ -z "$AH_VERSION" || "$AH_VERSION" == "null" ]]; then
            AH_VERSION="1.21.0"
          fi
          echo "::notice::Installing ArtifactHub CLI v${AH_VERSION}"
          curl -sSL "https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz" | tar xz
          sudo mv ah /usr/local/bin/

      - name: Lint ArtifactHub Metadata
        run: |
          ARTIFACT="${{ needs.validate.outputs.artifact }}"
          echo "::group::Linting charts/$ARTIFACT"
          ah lint --kind helm "charts/$ARTIFACT" || exit 1
          echo "::endgroup::"

  #############################################################################
  # Helm-Specific: K8s Compatibility Matrix Testing
  #############################################################################
  k8s-matrix-test:
    name: k8s-test (${{ matrix.k8s_version }})
    needs: [validate, artifacthub-lint]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      needs.artifacthub-lint.result == 'success' &&
      needs.validate.outputs.artifact != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - k8s_version: v1.32.11
            node_image: kindest/node:v1.32.11@sha256:5fc52d52a7b9574015299724bd68f183702956aa4a2116ae75a63cb574b35af8
          - k8s_version: v1.33.7
            node_image: kindest/node:v1.33.7@sha256:d26ef333bdb2cbe9862a0f7c3803ecc7b4303d8cea8e814b481b09949d353040
          - k8s_version: v1.34.3
            node_image: kindest/node:v1.34.3@sha256:08497ee19eace7b4b5348db5c6a1591d7752b164530a36f855cb0f2bdcbadd48
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: Create kind cluster
        uses: helm/kind-action@v1.13.0
        with:
          node_image: ${{ matrix.node_image }}

      - name: Run chart-testing (install)
        id: install-test
        run: |
          echo "::group::Installing charts on K8s ${{ matrix.k8s_version }}"
          if [[ "${{ github.event.inputs.test_all }}" == "true" ]]; then
            ct install --config ct-install.yaml --all --target-branch main
          else
            ct install --config ct-install.yaml --target-branch main
          fi
          echo "::endgroup::"

      - name: Generate Test Digest
        id: digest
        if: success()
        run: |
          DIGEST=$(echo -n "k8s-test-${{ matrix.k8s_version }}-${{ github.sha }}-${{ github.run_id }}" | sha256sum | cut -d' ' -f1)
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Generate Test Attestation
        id: test-attestation
        if: success()
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "k8s-test-${{ matrix.k8s_version }}"
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: false

  #############################################################################
  # Skip jobs (satisfy required checks when no charts change)
  #############################################################################
  artifacthub-lint-skip:
    name: artifacthub-lint
    needs: validate
    if: needs.validate.outputs.artifact == '' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No chart changes detected, skipping ArtifactHub lint"

  k8s-test-skip-v1-32:
    name: k8s-test (v1.32.11)
    needs: validate
    if: needs.validate.outputs.artifact == '' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No chart changes detected, skipping K8s v1.32.11 test"

  k8s-test-skip-v1-33:
    name: k8s-test (v1.33.7)
    needs: validate
    if: needs.validate.outputs.artifact == '' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No chart changes detected, skipping K8s v1.33.7 test"

  k8s-test-skip-v1-34:
    name: k8s-test (v1.34.3)
    needs: validate
    if: needs.validate.outputs.artifact == '' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No chart changes detected, skipping K8s v1.34.3 test"
