# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
#
# Workflow 1: Validate Initial Contribution
#
# Validates contributions to the integration branch with comprehensive checks
# and generates attestations for each validation step.
#
# Calls reusable workflow from aRustyDev/gh for generic validation,
# plus local Helm-specific jobs (ArtifactHub lint).
#
# Trigger: Pull request targeting the integration branch
#
# See: .claude/plans/chart-release-workflows/workflow-1/plan.md

name: Validate Contribution PR

on:
  pull_request:
    branches:
      - integration
  workflow_dispatch:
    inputs:
      test_all:
        description: 'Test all charts (not just changed)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  id-token: write
  attestations: write

env:
  TARGET_BRANCH: integration

jobs:
  #############################################################################
  # Generic Validation (via reusable workflow)
  #############################################################################
  validate:
    uses: aRustyDev/gh/.github/workflows/atomic-release-validate-contribution.yml@atomic-release-v0.1.0
    with:
      artifact_path: "charts"
      manifest_file: "Chart.yaml"
      target_branch: "integration"
      lint_command: "ct lint --config ct.yaml --target-branch $TARGET_BRANCH"
      commitlint_config: "commitlint.config.mjs"
      generate_changelog: true
      cliff_config: ".github/cliff.toml"
      test_all: ${{ github.event.inputs.test_all == 'true' }}

  #############################################################################
  # Helm-Specific: ArtifactHub Metadata Lint
  #############################################################################
  artifacthub-lint:
    name: artifacthub-lint
    if: needs.validate.outputs.artifacts_changed == 'true' || github.event.inputs.test_all == 'true'
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ArtifactHub CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest version using authenticated API to avoid rate limits
          AH_VERSION=$(gh api repos/artifacthub/hub/releases/latest --jq '.tag_name' | sed 's/^v//')
          if [ -z "$AH_VERSION" ] || [ "$AH_VERSION" = "null" ]; then
            echo "Failed to get ArtifactHub version, using fallback"
            AH_VERSION="1.21.0"
          fi
          echo "Installing ArtifactHub CLI v${AH_VERSION}"
          curl -sSL "https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz" | tar xz
          sudo mv ah /usr/local/bin/

      - name: Lint ArtifactHub metadata
        id: lint
        run: |
          FAILED=0
          for chart in charts/*/; do
            echo "::group::Linting $chart"
            if ! ah lint --kind helm "$chart"; then
              FAILED=1
            fi
            echo "::endgroup::"
          done
          exit $FAILED

      - name: Generate lint digest
        id: digest
        run: |
          DIGEST=$(echo -n "artifacthub-lint-${{ github.sha }}" | sha256sum | cut -d' ' -f1)
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Generate attestation
        id: attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "w1-artifacthub-lint"
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: false

      - name: Update attestation map
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          source .github/scripts/attestation-lib.sh
          update_attestation_map \
            "artifacthub-lint" \
            "${{ steps.attestation.outputs.attestation-id }}"

  #############################################################################
  # Skip jobs for no-change scenarios (satisfies required checks)
  #############################################################################
  artifacthub-lint-skip:
    name: artifacthub-lint
    needs: validate
    if: needs.validate.outputs.artifacts_changed != 'true' && github.event.inputs.test_all != 'true'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No chart changes detected, skipping artifacthub-lint"

  # NOTE: Auto-merge is handled by a separate workflow (auto-merge-integration.yaml)
  # that uses workflow_run trigger. This ensures the auto-merge logic runs from
  # the default branch (main) rather than requiring sync to integration branch.
