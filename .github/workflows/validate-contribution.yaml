# Workflow 1: Validate Initial Contribution
#
# Validates contributions to the integration branch with comprehensive checks
# and generates attestations for each validation step.
#
# Trigger: Pull request targeting the integration branch
#
# Jobs:
#   - lint-test: Chart linting and installation testing (matrix: K8s versions)
#   - artifacthub-lint: ArtifactHub metadata validation
#   - commit-validation: Conventional commit message validation
#   - changelog: Per-chart changelog generation
#
# Each job generates a GitHub attestation stored in the PR description.
#
# See: .claude/plans/chart-release-workflows/workflow-1/plan.md

name: W1 - Validate Contribution

on:
  pull_request:
    branches:
      - integration
  workflow_dispatch:
    inputs:
      test_all:
        description: 'Test all charts (not just changed)'
        required: false
        default: false
        type: boolean

# Permissions required for attestations and PR updates
permissions:
  contents: read
  pull-requests: write
  id-token: write
  attestations: write

env:
  # Target branch for chart-testing comparisons
  TARGET_BRANCH: integration

jobs:
  #############################################################################
  # Detect changed charts and prepare for parallel jobs
  #############################################################################
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      charts_changed: ${{ steps.detect.outputs.charts_changed }}
      changed_charts: ${{ steps.detect.outputs.changed_charts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed charts
        id: detect
        run: |
          source .github/scripts/attestation-lib.sh

          # Detect changes against target branch
          CHANGED=$(detect_changed_charts "" "$TARGET_BRANCH")

          if [[ -n "$CHANGED" ]]; then
            echo "charts_changed=true" >> "$GITHUB_OUTPUT"
            echo "changed_charts=$CHANGED" >> "$GITHUB_OUTPUT"
          else
            echo "charts_changed=false" >> "$GITHUB_OUTPUT"
            echo "changed_charts=" >> "$GITHUB_OUTPUT"
          fi

  #############################################################################
  # Lint Charts (Static Analysis)
  # NOTE: ct install (K8s deployment tests) moved to W5 for per-chart testing
  #############################################################################
  lint:
    name: lint
    needs: detect-changes
    if: needs.detect-changes.outputs.charts_changed == 'true' || github.event.inputs.test_all == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: Run chart-testing (lint)
        id: lint
        run: |
          if [[ "${{ github.event.inputs.test_all }}" == "true" ]]; then
            ct lint --config ct.yaml --all --target-branch "$TARGET_BRANCH"
          else
            ct lint --config ct.yaml --target-branch "$TARGET_BRANCH"
          fi

      - name: Generate lint digest
        id: digest
        run: |
          # Create a digest of the lint results for attestation
          DIGEST=$(echo -n "lint-${{ github.sha }}" | sha256sum | cut -d' ' -f1)
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Generate attestation
        id: attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "w1-lint"
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: false

      - name: Update attestation map
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          source .github/scripts/attestation-lib.sh
          update_attestation_map \
            "lint" \
            "${{ steps.attestation.outputs.attestation-id }}"

  #############################################################################
  # ArtifactHub Metadata Lint
  #############################################################################
  artifacthub-lint:
    name: artifacthub-lint
    needs: detect-changes
    if: needs.detect-changes.outputs.charts_changed == 'true' || github.event.inputs.test_all == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ArtifactHub CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest version using authenticated API to avoid rate limits
          AH_VERSION=$(gh api repos/artifacthub/hub/releases/latest --jq '.tag_name' | sed 's/^v//')
          if [ -z "$AH_VERSION" ] || [ "$AH_VERSION" = "null" ]; then
            echo "Failed to get ArtifactHub version, using fallback"
            AH_VERSION="1.21.0"
          fi
          echo "Installing ArtifactHub CLI v${AH_VERSION}"
          curl -sSL "https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz" | tar xz
          sudo mv ah /usr/local/bin/

      - name: Lint ArtifactHub metadata
        id: lint
        run: |
          FAILED=0
          for chart in charts/*/; do
            echo "::group::Linting $chart"
            if ! ah lint --kind helm "$chart"; then
              FAILED=1
            fi
            echo "::endgroup::"
          done
          exit $FAILED

      - name: Generate lint digest
        id: digest
        run: |
          DIGEST=$(echo -n "artifacthub-lint-${{ github.sha }}" | sha256sum | cut -d' ' -f1)
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Generate attestation
        id: attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "w1-artifacthub-lint"
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: false

      - name: Update attestation map
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          source .github/scripts/attestation-lib.sh
          update_attestation_map \
            "artifacthub-lint" \
            "${{ steps.attestation.outputs.attestation-id }}"

  #############################################################################
  # Commit Message Validation
  #############################################################################
  commit-validation:
    name: commit-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        id: commitlint
        uses: wagoid/commitlint-github-action@v6
        with:
          configFile: commitlint.config.js

      - name: Generate validation digest
        id: digest
        run: |
          DIGEST=$(echo -n "commit-validation-${{ github.sha }}" | sha256sum | cut -d' ' -f1)
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Generate attestation
        id: attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "w1-commit-validation"
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: false

      - name: Update attestation map
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          source .github/scripts/attestation-lib.sh
          update_attestation_map \
            "commit-validation" \
            "${{ steps.attestation.outputs.attestation-id }}"

  #############################################################################
  # Changelog Generation (Per-Chart)
  #############################################################################
  changelog:
    name: changelog
    needs: detect-changes
    if: needs.detect-changes.outputs.charts_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-cliff
        uses: orhun/git-cliff-action@v4
        with:
          args: --version
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Generate changelogs for changed charts
        id: changelog
        env:
          CHANGED_CHARTS: ${{ needs.detect-changes.outputs.changed_charts }}
        run: |
          echo "# Changelog Preview" > changelog.md
          echo "" >> changelog.md

          for chart in $CHANGED_CHARTS; do
            echo "::group::Generating changelog for $chart"
            echo "## $chart" >> changelog.md
            echo "" >> changelog.md

            # Generate changelog for this chart only
            git cliff \
              --config .github/cliff.toml \
              --include-path "charts/$chart/**/*" \
              --unreleased \
              --strip header >> changelog.md 2>/dev/null || echo "_No conventional commits found for this chart._" >> changelog.md

            echo "" >> changelog.md
            echo "::endgroup::"
          done

          cat changelog.md

      - name: Add changelog comment to PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: changelog.md

      - name: Generate changelog digest
        id: digest
        run: |
          DIGEST=$(sha256sum changelog.md | cut -d' ' -f1)
          echo "digest=sha256:$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Generate attestation
        id: attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "w1-changelog"
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: false

      - name: Update attestation map
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          source .github/scripts/attestation-lib.sh
          update_attestation_map \
            "changelog" \
            "${{ steps.attestation.outputs.attestation-id }}"

  #############################################################################
  # Skip jobs for no-change scenarios (satisfies required checks)
  #############################################################################
  lint-skip:
    name: lint
    needs: detect-changes
    if: needs.detect-changes.outputs.charts_changed != 'true' && github.event.inputs.test_all != true
    runs-on: ubuntu-latest
    steps:
      - run: echo "No chart changes detected, skipping lint"

  artifacthub-lint-skip:
    name: artifacthub-lint
    needs: detect-changes
    if: needs.detect-changes.outputs.charts_changed != 'true' && github.event.inputs.test_all != true
    runs-on: ubuntu-latest
    steps:
      - run: echo "No chart changes detected, skipping artifacthub-lint"
