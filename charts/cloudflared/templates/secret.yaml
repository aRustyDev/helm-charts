{{/*
Mutual exclusivity validation: Cannot use externalSecrets with inline base64 secrets
*/}}
{{- if and .Values.externalSecrets.enabled .Values.tunnelSecrets.base64EncodedConfigJsonFile }}
{{- fail "Cannot use both externalSecrets.enabled=true and tunnelSecrets.base64EncodedConfigJsonFile. Choose one secret management method." }}
{{- end }}
{{- if and .Values.externalSecrets.enabled .Values.tunnelSecrets.base64EncodedPemFile }}
{{- fail "Cannot use both externalSecrets.enabled=true and tunnelSecrets.base64EncodedPemFile. Choose one secret management method." }}
{{- end }}
{{- if and .Values.externalSecrets.enabled .Values.tunnelSecrets.existingPemFileSecret.name }}
{{- fail "Cannot use both externalSecrets.enabled=true and tunnelSecrets.existingPemFileSecret. Choose one secret management method." }}
{{- end }}
{{- if and .Values.externalSecrets.enabled .Values.tunnelSecrets.existingConfigJsonFileSecret.name }}
{{- fail "Cannot use both externalSecrets.enabled=true and tunnelSecrets.existingConfigJsonFileSecret. Choose one secret management method." }}
{{- end }}
{{/*
Only render this Secret if:
1. externalSecrets is NOT enabled (ExternalSecret will create the secret instead)
2. AND at least one of the existing secret references is empty (need chart-managed secret)
*/}}
{{- if not .Values.externalSecrets.enabled }}
{{- if or (eq .Values.tunnelSecrets.existingPemFileSecret.name "") (eq .Values.tunnelSecrets.existingConfigJsonFileSecret.name "") }}
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: {{ include "cloudflared.fullname" . }}-credentials
  labels:
    {{- include "cloudflared.labels" . | nindent 4 }}
data:
  {{- if eq .Values.tunnelSecrets.existingConfigJsonFileSecret.name "" }}
  credentials.json: {{ required "Base64 encoded config file string is required! Run base64 -b 0 -i ~/.cloudflared/*.json and add output to tunnelSecrets.base64EncodedConfigJsonFile in values.yaml file." .Values.tunnelSecrets.base64EncodedConfigJsonFile | quote }}
  {{- end }}
  {{- if eq .Values.tunnelSecrets.existingPemFileSecret.name "" }}
  cert.pem: {{ required "Base64 encoded certificate pem file string is required! Run base64 -b 0 -i ~/.cloudflared/cert.pem and add output to tunnelSecrets.base64EncodedPemFile in values.yaml file." .Values.tunnelSecrets.base64EncodedPemFile | quote }}
  {{- end }}
{{- end }}
{{- end }}
